%
%~~
%~~ Desenvolvimento
%~~
%


\chapter{Desenvolvimento}
\label{chp:desenvolvimento}

O desenvolvimento do sistema foi dividido em duas partes principais: aplicação do servidor e aplicativo móvel para iPhone. As duas partes foram desenvolvidas paralelamente por cada integrante do grupo e foram realizados testes para cada funcionalidade desenvolvida. Foram especificadas interfaces de comunicação entre o servidor e o dispositivo móvel afim de padronizar e estabelecer as trocas de informações entre ambos. 

Neste capítulo são descritos separadamente os procedimentos executados para implementação de cada parte do projeto (servidor e aplicativo móvel) com seus respectivos códigos-fonte. Inicialmente é apresentada a implementação referente ao servidor separada por funcionalidades e por último é explicado a implementação em maiores detalhes do aplicativo móvel construído na plataforma iOS e os componentes utilizados.

\section{Servidor}
\label{sec:servidor}

Para que o desenvolvimento fosse mais ágil, utilizou-se o \emph{Scaffolding} do \emph{Rails}. O \emph{Scaffolding} gera toda a parte de CRUD dos objetos, inclusive o \emph{script} de criação de tabela no banco de dados, utilizando-se o \emph{WebService} \emph{RESTful} para acesso, criação e edição dos dados.

Foi registrado um domínio gratuito no site \url{http://www.co.cc/} com o nome \url{betterwayserver.co.cc} e foi contratado um plano de hospedagem de \emph{site} nos servidores da empresa TeHospedo: serviços de internet \cite{TeHospedo:site}.

\subsubsection{Criação de eventos} % (fold)
\label{ssub:criação_de_eventos}

Os eventos do trânsito são criados pelo usuário através do aplicativo móvel. O servidor tem o papel de receber as informações do novo evento e armazená-las no banco de dados.

Ao criar um recurso no \emph{Scaffolding} são geradas as classes do \emph{model} do recurso e seu \emph{controller} para acesso via requisições HTTP. A classe EventosController 

% subsubsection criação_de_eventos (end)

\subsubsection{Temporização do evento} % (fold)
\label{ssub:temporização_do_evento}

Os eventos informados pelos usuários são exibidos durante 30 minutos. Após esse período eles são marcados como inativos no banco de dados, não sendo mais informados pelo servidor.

Para a implementação da atualização dos registros no banco de dados utilizou-se o ``crontab'' do servidor. O ``crontab'' é um utilitário dos sistemas Unix e Solaris que permite a execução de comandos (tarefas) em \emph{background} a cada intervalo de tempo especificado.

Criou-se então, uma tarefa que atualiza o banco de dados inativando os eventos que ultrapassarem 30 minutos a partir do horário em que foram informados. Essa tarefa é executada a cada cinco minutos no servidor para que não haja sobrecarga no mesmo e pode ser vista a seguir.
\\

\begin{lstlisting}
0,5,10,15,20,25,30,35,40,45,50,55 * * * * cd ~/better_way && rails runner -e production app/cron/atualizar_eventos.rb
\end{lstlisting}

Basicamente a tarefa é executada quando os minutos do horário do servidor forem múltiplos de cinco utilizando o \emph{runner} do ambiente \emph{rails} em produção para executar o código \emph{Ruby} atualizar\_eventos.rb que é descrito a seguir.
\\

\begin{lstlisting}[language=Ruby]
	class AtualizarEventos < ActiveRecord::Base

	  Evento.update_all({:ativo => false}, ["ativo = 1 AND data_hora < ?", Time.now - 30.minutes])

	end
\end{lstlisting}

% subsubsection temporização_do_evento (end)

% subsection eventos (end)

\subsection{Registros} % (fold)
\label{sub:registros}


% subsection registros (end)

\subsection{Rotas} % (fold)
\label{sub:rotas}


% subsection rotas (end)

\subsection{Trânsito} % (fold)
\label{sub:trânsito}


% subsection trânsito (end)

% section servidor (end)

\section{Aplicativo móvel} % (fold)
\label{sec:aplicativo_móvel}

A aplicação \emph{BetterWay} construída para o ambiente iOS é o componente principal do projeto, tendo como objetivo controlar a requisição de rota para o usuário e da visualização da malha da situação de trânsito no mapa. Nesse contexto, todas as lógicas de visualização do trânsito estão contidos nesse módulo. Contém rotinas para envio constante de dados do usuário sobre sua posição e velocidade e também é responsável pelo envio de eventos e gerenciamento de endereços.


\subsection{Dificuldades iniciais}
\label{ssub:dificuldades_iniciais}
As dificuldades de construir a aplicação BetterWay para o dispositivo iPhone vem do momento de sua criação, uma vez que o grupo não possui o conhecimento sobre o framework de mapas e de requisições web. 
No estudo do framework de mapas para o Cocoa Touch, chamado MapKit, não existia métodos diretos para desenho de rotas e de camadas auxiliares para desenho encima da visao do mapa. Implementamos métodos indiretos para desenho através do framework CoreGraphics que deixava a aplicação sobrecarregada, pois neste método era necessário a recalculação de todas marcações realizadas no mapa a cada transição de movimento.
Porém com o lançamento do SDK 4.0 no final do mês de Agosto melhorias foram implementadas no framework MapKit, sendo agora possível a implementação de uma camada gráfica encima do mapa. A partir do estudo dessa camada, conseguimos implementar uma solução mais dinâmica onde já não era mais ncessário o recalculo de todas marcações para cada mudança no mapa.



\subsection{Bibliotecas utilizadas}
Para a aplicação no dispositivo iPhone, utiliza-se duas bibliotecas auxiliares na implementação.

\textbf{JSON:} Biblioteca de codificação/decodificação do protocolo padrão Json para leitura como dados para a linguagem Objetive-C. Protocolo JSON é utilizado como interface de comunicação entre o dispositivo móvel e o servidor.

\textbf{ASIHTTPRequest:} Biblioteca auxiliar para envio de requisições web nas utilizações GET, POST, UPDATE e DELETE. Realiza os procedimentos de verificação e delegação dos métodos existentes no Objetive-C.




\subsection{Classe delegadora: MapDirection}

Classe Delegadora principal da aplicação. Responsável por informar sobre a condições e informações básicas do aparelho e de coordenar todas as View Controllers do aplicativo, além de ser o responsável por manter as listas de permanências de dados sobre os últimos endereços usados e endereços favoritos.



Os dados a serem armazenados são manipulados pela classe NSUsersDefault, que guarda no SandBox da aplicação. Ao iniciar a aplicação, o método loadDatabase é chamado. Ao encerrar a aplicação, a classe delegate captura essa notificação e assim o processo se retenção de dados é realizada.

\begin{figure}
	\centering
	\includegraphics[scale=0.8]{img/iphone/appWillTerminate.png}
	\caption{Método de encerramento da aplicação.}
\end{figure}



Para o verificamento de conectividade do aparelho, implementou-se uma classe herdada de SCNetworkReachability, disponibilizada pela Apple a partir do SystemConfiguration.framework. Verifica-se a conexão com a internet via Edge/3G ou wifi.


\begin{figure}
	\centering
	\includegraphics[scale=0.8]{img/iphone/networkStatus.png}
	\caption{Método de verificação de conectividade}
\end{figure}


Possui objetos que verificam de tempo em tempo diversos atributos do aparelho:
\textbf{CLLocationManager:} Classe disponibilizada pela Apple que faz a verificação da disponibilidade do GPS. Possui diversos métodos de utilização do GPS, entre elas o método de buscar a posição atual do usuário.

\textbf{EventClock:} Objeto que realiza a rotina de atualização dos eventos esporadicamente. Ao encontrar um novo evento, realiza a rotina para adicionar no mapa de visualização para o usuário.

\textbf{RegisterClock:} Objeto que realiza a rotina de atualização dos eventos esporadicamente. Ao encontrar um novo evento, realiza a rotina para adicionar no mapa de visualização para o usuário.



\subsection{View Controller Principal: BetterWayViewController} % (fold)
\label{sec:betterwayviewcontroller}

Esta sessão contém a descrição da classe central da aplicação, sendo o responsável pela tela principal. Possui o mapa onde é identificado as funcionalidades de geração de rotas, informação do trânsito e de eventos para o usuário. Possui o UINavigatorController, que conecta todas as telas da aplicação.


\subsection{Módulo de geração de rota} % (fold)
\label{sec:modulo_transito}

Este módulo foi estruturada diversas View Controllers necessárias para o fluxo de interatividade com o usuário, que entra com os dados da via de destino e origem no aparelho. 

A seguir é apresentada o fluxograma da aplicação. O fluxo foi definido de tal maneira recursiva para o reaproveitamento das mesmas classes, sendo que ao passar o endereço de destino e o de origem, o usuário passe pelas mesmas telas. Decidimos por implementar algumas funcionalidades auxiliares como um armazenamento de endereços como um histórico e como uma lista favoritos, para uma melhor experiência de utilização para o usuário. 


\begin{figure}
	\centering
	\includegraphics[scale=0.2]{img/iphone/Destino.png}
	\includegraphics[scale=0.2]{img/iphone/Origem.png}
	\caption{Fluxograma para o módulo de geração de rota}
\end{figure}



Uma breve descrição para cada ViewController a seguir:
\textbf{RouteMenuViewController:} View Controller que exibe uma lista de opções para o usuário. Para o caso de se selecionar o endereço de destino a classe exibe as opções entrar com endereço ou utilizar da lista de favoritos. Para o caso de se selecionar o endereço de origem ela exibe além das opções disponíveis no caso de endereço destino, a opção de se utilizar o endereço atual do dispositivo.
\begin{figure}
	\centering
	\includegraphics[scale=0.2]{img/iphone/Destino.png}
	\includegraphics[scale=0.2]{img/iphone/Origem.png}
	\caption{Aplicação na tela de seleção de menu de endereços}
\end{figure}


\textbf{AddressViewController:} Classe que oferece a interface para o usuário digitar o endereço. Exibe uma lista do histórico da aplicação, que pode ser utilizada sem a necessidade de digitar novamente o endereço já usado.
\begin{figure}
	\centering
	\includegraphics[scale=0.2]{img/iphone/AddressViewController.png}
	\caption{Aplicação na tela de inclusão de endereço}
\end{figure}

\textbf{FavoriteListViewController:} Classe que exibe a lista de favoritos salvos pelo usuário. Pode-se excluir da lista arrastando o dedo encima do endereço favorito salvo, e confirmar a exclusão com o botão que aparece na tela.
\begin{figure}
	\centering
	\includegraphics[scale=0.2]{img/iphone/FavoriteListViewController.png}
	\caption{Aplicação na lista de favoritos}
\end{figure}



\textbf{SearchViewController:}
Classe que apresenta a tela que exibe informações do endereço encontrado a partir da requisição do usuário. Possui o endereço completo encontrado e um mapa para identificar a redondeza do local. O usuário possui as opcões de salvar no favorito, enviar via e-mail e confirmar o endereço.
\begin{figure}
	\centering
	\includegraphics[scale=0.2]{img/iphone/SearchViewController.png}
	\caption{Aplicação exibindo detalhes do endereço}
\end{figure}


Métodos de requisição de rotas é realizado a partir da requisição das posições de endereço de destino e origem no servidor. O servidor processa o pedido, e a partir dos dados da situação de trânsito, manipula o trajeto para uma melhor performance no tempo na viagem do usuário. Nas figuras abaixo, encontram-se os códigos usado para a requisição no servidor, e o tratamento de sua resposta.

\begin{figure}
	\centering
	\includegraphics[scale=0.6]{img/iphone/tracarRota.png}
	\caption{Método de requisição da rota}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[scale=0.6]{img/iphone/coreRotaResponse.png}
	\caption{Tratamento da resposta de requisição de rota}
\end{figure}


\textbf{FavoriteAddViewController:} View Controller com formulário para a entrada no nome do endereço favorito a ser adicionado.


\textbf{SendDestinationViewController:} Classe auxiliar para o envio via e-mail do endereço selecionado pelo usuário. Utiliza-se a classe MFMailComposeViewController disponibilizado pela Apple.




\subsection{Módulo de trânsito} % (fold)
\label{sec:modulo_transito}

Para implementação do módulo de trânsito é utilizado um método para chamadas contínuas de requisições no servidor para adquirir informações sobre a malha de tráfego nas redondezas que o usuário está visualizando. A malha é desenhada no mapa como se fosse uma lista de trajetos a serem desenhadas no mapa.

\textbf{TrafficClock:} Objeto que realiza a rotina de atualização da malha de tráfego esporadicamente. Ao movimentar o mapa, faz a requisição automática caso esteja ativado.



\subsection{Módulo de eventos} % (fold)
\label{sec:modulo_eventos}

% section trânsito (end)

% section aplicativo_móvel (end)
